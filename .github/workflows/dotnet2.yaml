name: Build and Push Docker image

on:
  push:
    branches:
      - main  # Trigger the workflow when there's a push to the main branch
  pull_request:
    branches:
      - main

jobs:
  build_and_push:
    runs-on: windows-latest  # This workflow will run on a Windows runner

    steps:
    - name: Check out the repository
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-north-1

    - name: Log in to Amazon ECR
      run: |
        aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin 973905176396.dkr.ecr.us-west-2.amazonaws.com

    - name: Build Docker image
      run: |
        docker build . -t 973905176396.dkr.ecr.us-west-2.amazonaws.com/github-build:latest

    - name: Push Docker image to Amazon ECR
      run: |
        docker push 973905176396.dkr.ecr.us-west-2.amazonaws.com/github-build:latest

    - name: Deploy to Amazon ECS
      uses: aws-actions/amazon-ecs-deploy-task-definition@v1
      with:
        task-definition: windows1-revision1.json
        service: window1
        cluster: fargate
        wait-for-service-stability: true


    - name: Set up .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: '5.x'

    - name: Install sqlpackage
      run: |
        Invoke-WebRequest -Uri https://aka.ms/sqlpackage-win -OutFile sqlpackage.zip
        Expand-Archive -Path sqlpackage.zip -DestinationPath $env:ProgramFiles\SqlPackage
        $env:Path += ";$env:ProgramFiles\SqlPackage"

    - name: Deploy DACPAC to AWS RDS
      env:
        CONNECTION_STRING: "Server=database1.czuc8vh8sz9x.eu-north-1.rds.amazonaws.com;Database=database1;User Id=admin;Password=kuroky1234;"
      run: |
        sqlpackage /Action:Publish /SourceFile:./data.dacpac /TargetConnectionString:"Server=database1.czuc8vh8sz9x.eu-north-1.rds.amazonaws.com;Database=database1;User Id=admin;Password=kuroky1234;"